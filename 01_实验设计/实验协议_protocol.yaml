protocol_version: "2.0"

meta:
  project: "Prompt Drift Lab"
  document_type: "experiment_protocol"
  protocol_id: "PDL-EXP-0001"
  created_at: "2025-12-21"
  owner: "yuchenzhu-research"
  contact: ""
  repository:
    url: ""
    git_commit: ""
  intent: "评估结构化输出任务在提示词微小扰动下的稳健性（prompt drift）。"

research_question:
  phenomenon: "提示词/格式/措辞发生微小变化时的 prompt drift"
  primary_outcomes:
    - "指令遵循率（instruction_following_rate）"
    - "结构稳定性（structured_output_stability）"
    - "语义漂移发生率（semantic_drift_incidence）"
  non_goal: "本实验不评估事实正确性或知识覆盖能力，仅评估是否按要求完成任务与结构。"

task_spec:
  question_set:
    path: "01_实验设计/问题集.jsonl"
    version_tag: ""
    checksum_sha256: ""
    note: "题集作为实验输入资产；任何修改应更新 version_tag（可选填 checksum 以便审计）。"
  output_schema:
    path: "01_实验设计/标准输出结构.md"
    version_tag: ""
    checksum_sha256: ""
    note: "定义被测模型应输出的结构模板；评测以此为准。"

prompt_spec:
  variants:
    - id: "baseline"
      description: "对照基线版本：常规、你认为最合理的提示词。"
    - id: "long"
      description: "更长、更解释、更重复约束：检验“提示词更长是否更听话”。"
    - id: "weak"
      description: "弱化硬约束：检验结构是否依赖强指令才能维持。"
    - id: "conflict"
      description: "引入冲突/歧义约束：检验模型如何选择、妥协或崩坏。"
  trigger_types:
    - id: "implicit"
      description: "结构要求为暗示/推荐（soft constraint）。"
    - id: "explicit"
      description: "结构要求为必须/严格遵守（hard constraint / strict compliance）。"

run_spec:
  execution_mode: "manual_ui"   # manual_ui | api_script
  session_policy: "new_chat_per_sample"
  generator_models:
    - model_id: "chatgpt"
      model_version: ""
      provider: ""
    - model_id: "gemini"
      model_version: ""
      provider: ""
    - model_id: "claude"
      model_version: ""
      provider: ""
  decoding_params:
    temperature: 0
    top_p: 1.0
    max_tokens: null
    seed: null
  time_window_local: ""
  notes: ""

design_matrix:
  # 本轮实验实际覆盖的条件（以真实跑过的为准）
  questions: ["q3", "q4"]
  prompt_versions: ["baseline", "long", "weak", "conflict"]
  triggers: ["implicit", "explicit"]
  replicates_per_cell: 1
  expected_total:
    formula: "len(questions) * len(prompt_versions) * len(triggers) * len(generator_models) * replicates_per_cell"
    value: 16

artifacts:
  raw_outputs_dir: "04_实验结果/raw_pdfs/"
  eval_bundle_dir: "04_实验结果/eval_bundles/"
  summary_dir: "04_实验结果/summary/"
  naming_convention:
    pdf_filename_pattern: "q{qid}_{version}_{trigger}_{model}_r{rep}.pdf"
    allowed_tokens:
      qid: ["q1", "q2", "q3", "q4"]
      version: ["baseline", "long", "weak", "conflict"]
      trigger: ["implicit", "explicit"]
      model: ["chatgpt", "gemini", "claude"]
      rep_prefix: "r"
    note: "统一命名用于后续自动聚合与审计；不建议使用空格命名。"

evaluation_spec:
  rubric:
    path: "03_评测规则/rubric.md"
    version_tag: ""
    checksum_sha256: ""
    note: "Rubric 为评分口径真值源；维度 key 必须与 eval_bundle 输出一致。"
  judge:
    judge_type: "llm"     # llm | human | hybrid
    judge_model_id: "chatgpt"
    judge_model_version: ""
  scoring:
    scale: "0-2"
    orientation: "higher_is_better"
    dimensions:
      - key: "A_structure"
        definition: "是否遵循目标结构/模板（段落或字段齐全且顺序正确）。"
      - key: "B_snapshot_constraint"
        definition: "事实快照是否做到‘只陈述不分析’，无额外解释性扩展。"
      - key: "C_actionability"
        definition: "搜索指令/动作是否可执行、可复现（可直接照做）。"
      - key: "D_completeness"
        definition: "是否覆盖题目要求的全部要点/段落，缺漏程度如何。"
      - key: "E_drift_failure"
        definition: "是否避免明显漂移（改任务/越界/跑题/角色混乱等）。"
  invalid_policy:
    definition: "仅当样本无法进入可评分空间时标记 invalid（拒答、空输出、严重截断或结构不可判定）。"
    rule: "只要能评分，就应打分（即使很差也打低分），不要用 invalid 丢弃低分样本。"
    required_fields: ["file", "reason"]

bundle_output_format:
  eval_bundle_json_required_fields:
    - "bundle_meta"
    - "per_file_scores"
    - "invalid_files"
  bundle_meta_required_fields:
    - "bundle_size"
    - "questions"
    - "versions"
    - "trigger_types"
    - "generator_models"
    - "judge_model"
    - "run_params"

quality_checks:
  must_pass:
    - "所有输出文件名可解析为 (qid, version, trigger, model, rep)。"
    - "每个 PDF 要么被评分（per_file_scores），要么进入 invalid_files（不可遗漏）。"
    - "评分维度 key 与 rubric 完全一致。"
    - "实际样本数与 expected_total 一致；若不一致必须解释差异。"
  recommended:
    - "为问题集/输出结构/rubric 记录 checksum 以支持可审计复现。"
    - "若采用人工评分，应记录评分者与一致性/仲裁流程。"
